<!--	
		Created by Brendon Albertson
-->

<!DOCTYPE html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="wikipedia_fetcher.js"></script>

<head>
	<link rel="stylesheet" type="text/css" href="styles.css">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
	<link href="https://fonts.googleapis.com/css?family=Poiret+One" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">

</head>
	
<body>

	<div id='start-screen'>
		<div id='start-text'>
			Text Mix!
			<p id=subtitle>A more fun way to read, sentence by sentence.</p>
		</div>

		<div id="settings-area">

			<div class="settings-box" id="difficulty-settings">
				<h3>Chunk size:</h3>
				<input type="radio" id="radio-easy" name="difficulty" value="6">  
				<label for="radio-easy">6 words (Easiest)</label><br>
				<input type="radio" id="radio-normal" name="difficulty" value="4" checked="checked">
				<label for="radio-normal">5 words</label><br>
				<input type="radio" id="radio-hard" name="difficulty" value="3">
				<label for="radio-hard">4 words</label><br>
				<input type="radio" id="radio-expert" name="difficulty" value="2">
				<label for="radio-expert">2 words</label><br>
				<input type="radio" id="radio-crazy" name="difficulty" value="1">
				<label for="radio-crazy">1 word (Hardest)</label><br>
			</div>

			
			<div class="settings-box" id='game-mode-settings'>
				<h3>Game Mode</h3>
				<input type="radio" id="radio-randomize-no" name="randomize" value="no" checked="checked" >
				<label for="radio-randomize-no">Ordered Sentences</label><br>
				<input type="radio" id="radio-randomize-yes" name="randomize" value="yes">
				<label for="radio-randomize-yes">Random Sentences</label><br>
				<input type="radio" id="radio-randomize-reading" name="randomize" value="reading-mode" >
				<label for="radio-randomize-reading">Reading Mode</label><br>
			</div>

			<div class="settings-box" id='learning-mode-settings'>
				<h3>Learning Mode</h3>
				<input type="radio" id="radio-learning-jumble" name="learning" value="jumble" checked="checked" >
				<label for="radio-learning-jumble">Focus on syntax/word order</label><br>
				<input type="radio" id="radio-learning-articles" name="learning" value="articles" >
				<label for="radio-learning-articles">Focus on articles</label><br>
				<input type="radio" id="radio-learning-prepositions" name="learning" value="prepositions">
				<label for="radio-learning-prepositions">Focus on prepositions</label><br>
				<input type="radio" id="radio-learning-grammar" name="learning" value="grammar">
				<label for="radio-learning-grammar">Focus on grammatical words</label><br>
				<input type="radio" id="radio-learning-cloze" name="learning" value="cloze">
				<label for="radio-learning-cloze">nth word cloze (n=chunk size)</label><br>
			</div>


			<div class="settings-box" id='text-source-settings'>
				<h3>Text source:</h3>

				<input onclick="languagePopup(true); pastePopup(false); challengesPopup(false)" type="radio" id="radio-wikipedia" name="datasource" value="wikipedia" checked="checked">
				<label for="radio-wikipedia">Wikipedia</label><br>


				<input onclick="languagePopup(false); pastePopup(false); challengesPopup(true)" type="radio" id="radio-textfile" name="datasource" value="preset text">
				<label for="radio-textfile">Preset Challenges</label><br>


				<input onclick="languagePopup(false); pastePopup(true); challengesPopup(false)" type="radio" id="radio-paste" name="datasource" value="paste">
				<label for="radio-paste">Paste text</label><br>


				<input onclick="languagePopup(false); pastePopup(false); challengesPopup(false)" type="radio" id="radio-preset" name="datasource" value="test string">
				<label for="radio-preset">Test String</label><br>

			</div>

			<div class="settings-box popup-settings" id='language-settings'>
				<h3>Language:</h3>
				<input type="radio" id="radio-simple-english" name="language" value="simple" checked="checked" >
				<label for="radio-simple-english">Simple English</label><br>
				<input type="radio" id="radio-english" name="language" value="en">
				<label for="radio-english">Normal English</label><br>
				<input type="radio" id="radio-japanese" name="language" value="ja">
				<label for="radio-japanese">Japanese</label><br>
				<h3>Search term:</h3>
				<input type="text" id="search-term" placeholder="(tea, Barack Obama, France...)">

				<div id='birdpic'></div>
			</div>

		</div>

		
		<div class="row">
			<div class="settings-box popup-settings" id='paste-div'>
				<h3>Paste text here:</h3>
				<textarea id="paste-input"  name="paste-input" placeholder="Paste some text!  About a paragraph or so is good.  A whole article is good for a challenge!" required></textarea>
			</div>
		</div>

		<div class="row">
			<div class="settings-box popup-settings" id='challenges-container'>
				<h3>Challenges:</h3>
			</div>
		</div>
		
		<div class="row">
			<div id='start-button' class="launcher-button">
				START <br><img src='images/start.png' style='height: 35px'>
			</div>
			<div id="quickstart-button" class="launcher-button">
				QUICK START <br><img src='images/quickstart.png' style='height: 35px'>
			</div>
			<div id="save-button" class="launcher-button">
				Create & Share <br><img src='images/share.png' style='height: 35px'>
			</div>
		</div>
		<div class="row">
			<div id="popup-explanation"></div>
		</div>
	


		
	</div>

	<div id="hidden-text-div" style="visibility: hidden"></div>  
	<!--This is where the Wikipedia search result text goes (can't find a way to put it in a variable since it's Ajax onreadystatechange)-->


	<div id='answerbox'>
		<div id='previous-sentences-div'></div>
		<div id='answersentence'></div>
	</div>
	<div id='word-div-container'></div>
	<div id='score-box' class='small-box'> Score: 0      </div>
	<div id='timer' class='small-box'>     Time: 0       </div>
	<div id='game-over'>                   GAME OVER     <br>
		<div class='small-box reset-button' id='try-again-button'> 	Try Again     </div>  
		<div class='small-box reset-button' id='main-menu-button'>	Main Menu     </div> 
	</div>
	<div id='progress-box-outer'>          Progress: 0%  <div id='progress-box-inner'></div></div>
	


	<script src="wikipedia_fetcher.js"></script>
	<script src="shuffle.js"></script>
	<script src="chunk_array.js"></script>
	<script src="get_data.js"></script>
	<script>

		//display or hide the language setting for wikipedia and the box to paste text if these settings are selected:
		function languagePopup(yes) {
			var opacity;
			var clickable;
			if (yes) {
				opacity = '100%';
				clickable = "auto";
				getSettings();
			} else {
				opacity = '50%';
				clickable = "none";
			};
			document.getElementById('language-settings').style.opacity = opacity;
			document.getElementById('language-settings').style.pointerEvents = clickable;
		}

		function pastePopup(yes) {
			var display;
			if (yes) {
				display = 'block';
				getSettings();
			} else {
				display = 'none';
			};
			document.getElementById('paste-div').style.display = display;
			
		}

		function challengesPopup(yes) {
			var display;
			if (yes) {
				display = 'block';
				getSettings();
				loadPresetTexts();
				//dataSource = "preset text"
			} else {
				display = 'none';
			};
			document.getElementById('challenges-container').style.display = display;
		}


		var time;
		var score = 0;
		var count = 0;
		var listOfSentences = [];
		var rand;
		var rainbowMode = false;
		var sentenceWords = [];
		var jumbledSentence = [];
		var sentenceString = '';
		var answerBox = document.getElementById('answerbox');
		var answerSentence = document.getElementById('answersentence');
		var answer;
		var previousSentences = document.getElementById("previous-sentences-div");
		var wordsToUndo =[];
		var undoHistory =[];
		var indexOfBlank;
		var wordsEntered = 0;   //number of words that have been clicked so far
		var wordGroupSize = 5; 
		var clozeSentence = [];
		var clozeWords = [];
		var randomMode = false;
		var readingMode = false; //mode to keep sentences on the screen after they've been completed
		var articleList = ['a','an','the'];
		var prepList = ['in','at','on','for','of','with','out','to','from'];
		var grammarList = [];
		var clickedDivs = [];
		var undoCount = 0;
		var skip = false;
		var dataSource = "wikipedia";
		var searchTerm;
		var language = "simple";
		var learningMode;
		var foundArticle = false;
		var progress = 0;
		var windowWidth = window.innerWidth;
		var imageDiv;
		var imageContainer;
		var imageVisible = false;
		var finishedSentences = 0;
		var needToCheckRadios = true;
		var loadedPresetTexts = false; //not loaded yet
	//	var textFile;  
		var winScreen;
		var youWon;
		var tryAgain;
		var saved;
		var existingData;
		var presetTexts = [];
		var dataToWrite = ['test sentence 1', 'test sentence 2'];
		var loadScreen;
		const urlParams = new URLSearchParams(window.location.search); //gets everything after the ?
		var needToLoadText = urlParams.get('loadsavedtext');
		var saveCode = urlParams.get('saveCode');  //gets what comes after saveCode= in the url (null if there's not saveCode specified)


		loadTxtFile("100commonwords.txt");  //load the grammarList

		//set up start buttons:

		document.getElementById('start-button').addEventListener("click", runApp);
		document.getElementById('quickstart-button').addEventListener("click", function() {
			needToCheckRadios = false;
			document.getElementById('search-term').value = "tea";
			runApp();
		});
		document.getElementById('save-button').addEventListener("click", saveAndShare);

		//create popup explanations:

		function createPopupExplanations(thingToHoverOver, textToPopup) {
			thingToHoverOver.addEventListener("mouseover", function() {
				document.getElementById('popup-explanation').style.visibility = "visible";
				document.getElementById('popup-explanation').innerHTML = textToPopup;
			});
			thingToHoverOver.addEventListener("mouseout", function() {
				document.getElementById('popup-explanation').style.visibility = "hidden";
			})
		}

		createPopupExplanations(document.getElementById('start-button'), "Start the game with the above settings.");
		createPopupExplanations(document.getElementById('quickstart-button'), "Start the game with a random text and default settings.");
		createPopupExplanations(document.getElementById('save-button'), "Create a game with the above settings and get a unique URL to share with students.");

		createPopupExplanations(document.getElementById('difficulty-settings'), "Choose how each sentence is split. '1' means a traditional word jumble where each word must be unscrambled.");
		createPopupExplanations(document.getElementById('game-mode-settings'), "Preset sentences randomly or in order.  In 'reading mode', completed sentences stay on the screen so you can ready the next sentence in context.");
		createPopupExplanations(document.getElementById('learning-mode-settings'), "Choose what kind of practice the activity should provide.");
		createPopupExplanations(document.getElementById('text-source-settings'), "Select the source of text. If 'Wikipedia', also select language and search term.");
		createPopupExplanations(document.getElementById('language-settings'), "(For Wikipedia text) Choose the language and search term to get an article exerpt. Case sensitive - must capitalize proper nouns!");


		


// LOAD --------------------------

		function loadText() {
		//If loading from saved URL, ignore all the setup stuff below; just load the text and getData() will handle the rest
			if(needToLoadText == 'yes') {
				dataSource = "load";
				needToCheckRadios = false;
				//load up the text:
				getData(saveCode, 'read one text', null, null, null); //this sets existingData.  saveCode tells which array in the array of arrays in the JSON file.  This array will be set as listOfSentences.
				console.log("Loaded text from JSON file.");
			} else{
				console.log("Didn't load text; settings must be chosen.");
			};
		}

		loadText();

// LOAD --------------------------


		//set up challenges
		function loadPresetTexts() {
			getData(null, 'get all texts', null, null, null);  //This will set up presetTexts array
		}

		function makePresetTextDivs() {  //This function gets run by getData after presetTexts have been loaded

			if (!loadedPresetTexts) {  // ifnot yet loaded
			var challengesContainer = document.getElementById('challenges-container');
			/*	var challengesData = [  
				//"name" is filename of txt files in "texts" folder (don't include .txt)
					{	name: "moon_and_sleep",
						description: "Full moons and sleep",
						type: "paragraph",
						difficulty: "normal"
					},
					{	name: "thin_house",
						description: "London's thinnest house",
						type: "article",
						difficulty: "difficult"
					},
					{	name: "sentences",
						description: "Simple warm-up",
						type: "sentences",
						difficulty: "easy"
					}];
					*/

					//make the preset text (challenge) divs:
				for (i=0; i<presetTexts.length; i++) {
					var challengeDiv = document.createElement('div');
					challengeDiv.setAttribute("class", "challenge");
					challengeDiv.setAttribute("id", "challenge-"+i);
					challengesContainer.appendChild(challengeDiv);

					challengeDiv.innerHTML = "<b>"+presetTexts[i][0].substr(0,40)+"...</b><br><br>( "+presetTexts[i].length+" sentences )";  //shows first 36 characters and length of text

				};

				//Once all the divs have been made, add the event listeners (must do this separately so it doesn't keep looping the creation of event listeners over just the variable challengeDiv):
				for (i=0; i<presetTexts.length; i++) {
					document.getElementById("challenge-"+i).addEventListener("click", function() {
						var index = parseInt(this.id.substr(10));  //get the number of the challenge div (same as i, but can't use i here because i is part of this FOR loop, which can't be seen by the function later on)
						listOfSentences = presetTexts[index];
						runApp();
					});
				}
			};

			loadedPresetTexts = true;  //prevent it from loading again if this radio button is unclicked and then clicked again
		}



		//Set up the "save & share" option:
		//pass parameters through the URL like this: ?name=brendon&hair=brown

		function saveAndShare() {  //save the text you chose and spit out a URL to share with others
			
			saved = true;  //Let's it know that it's been saved, so savedScreen can be removed later

			saveCode = randomColor().split("#")[1];  //get random string without the #
			var urlToShare = location.protocol + '//' + location.host + location.pathname + "?loadsavedtext=yes" + "&saveCode=" + saveCode;
			var urlField = document.createElement('input');
			urlField.type = "text";
			urlField.size = 60;
			urlField.style.fontSize = "26px";
			urlField.value = urlToShare;

			urlField.onclick = function() {
				this.select();
				document.execCommand('copy');
				var p = document.createElement('p');
				p.innerHTML = "<h4>Copied to clipboard</h4>";
				saveScreen.appendChild(p); 
			}

			console.log("new saveCode = " + saveCode);
			console.log("URL = " + urlToShare);

			var saveScreen = createScreen("<br><br><br><h2>Share this link to your saved TextMix:</h2><br><br>");
			document.body.appendChild(saveScreen);

			saveScreen.appendChild(urlField);

			getSettings();

			function writeWikiText() { //after wikiSearch is complete, run this as callback function.
				var separator = ". ";
				listOfSentences = document.getElementById("hidden-text-div").textContent.split(separator);
				getData(saveCode, "write", randomMode, wordGroupSize, listOfSentences);
			}

			if(dataSource == "wikipedia"){
				searchTerm = document.getElementById('search-term').value;
				wikiSearch(searchTerm, language, "hidden-text-div",	writeWikiText);
			} 
			else {
				getText();  //run everything except getOneSentence() and makeDivs().  This will set up listOfSentences.
				//finally, write the listOfSentences array to JSON file:  saveCode tells which array in the array of arrays in the JSON file.  This array will be set as listOfSentences.
				getData(saveCode, "write", randomMode, wordGroupSize, listOfSentences);
			};

			var backButtonContainer = document.createElement("div");
			backButtonContainer.style.display = "inline-block";
			backButtonContainer.style.width = "200px";
			var backButton = document.createElement("div");
			backButton.className = "word-div";
			backButton.innerHTML = "BACK";

			backButton.addEventListener("click", function() {
				document.body.removeChild(saveScreen);     //return to the main menu
			});

			saveScreen.appendChild(backButtonContainer);
			backButtonContainer.appendChild(backButton);


			var playNowButton = document.createElement("div");
			playNowButton.className = "word-div";
			playNowButton.innerHTML = "Play Now";

			playNowButton.addEventListener("click", function() {
				window.location.href = urlToShare;   // go to the link just created
			});

			backButtonContainer.appendChild(playNowButton);



		}

		function makeLoadScreen() {

			loadScreen = createScreen("<br><br><br><h2>Are you ready?</h2><br><br>");
			loadScreen.id = "load-screen";
			document.body.appendChild(loadScreen);
			var loadStartButton = document.createElement('div');
			loadStartButton.className = "launcher-button";
			loadStartButton.innerHTML = "START";
			loadStartButton.addEventListener("click", function() {

				$("#start-screen").animate({left: windowWidth}, 500);  //push it from the left over 500ms
				$("#load-screen").animate({left: windowWidth}, 500);  //push it from the left over 500ms
				
				setInterval(incrementTime, 100);
			});
			
			loadScreen.appendChild(loadStartButton);

		}



		function runApp() {
				searchTerm = document.getElementById('search-term').value;
				if (dataSource=='wikipedia' && searchTerm == ''){
					alert('Please enter a search term!');
					return;
				}

				if (needToLoadText == "yes") {  //if ready() and getText() have already been run via  make_text_file.js
					makeLoadScreen()
				} 
				else {  //neet to load text via getText() below
					$("#start-screen").animate({left: windowWidth}, 500);  //push it from the left over 500ms
					setInterval(incrementTime, 100);
					getText();
				}		
		}

	
		//set game settings based on radio buttons:
		//set the corresponding setting variable
		//this is 'DRY' CODING RIGHT HERE!!!
		//can easily add new radio game settings here!
		function checkRadio(radioName) {
			var choices = document.getElementsByName(radioName);
			for (i=0; i<choices.length; i++) {
				if (choices[i].checked == true) {  //if radio button selected


					if(radioName == "randomize") { 
						if (choices[i].value == 'yes') {
							randomMode = true;
						}
						else if (choices[i].value == 'no') {
							randomMode = false;
						}
						else { //if reading mode is checked
							readingMode = true;
						}
					}	
					else if (radioName == "difficulty") {
						wordGroupSize = parseInt(choices[i].value); //radio btn values can only be strings
					}
					else if (radioName == "datasource") {
						dataSource = choices[i].value;
					}
					else if (radioName == "learning") {
						learningMode = choices[i].value;
						if (choices[i].value != 'jumble') {
							wordGroupSize = 1; //if articles or prepositions, set the word group size to 1
						}

					}
					else {
						language = choices[i].value;
					};
				} ;
			};
		};

		
		//a premade string for testing:
		const preMadeList = "A library is a great blessing. A library is said to be the storehouse of culture. The various books by the different authors and poets form a library. A society is known by the number of good libraries it has. Man\'s craving for knowledge is eternal. Libraries preserve various types of old and new books. There are also periodicals and daily papers to meet the demands of the people. In all ages, libraries have been considered the best medium of public instructions. An academic library is an essential part of an educational institution. It plays an important role in schools, colleges and universities. The books are issued to the students in term of weekly, fortnightly or monthly basis. Generally a reading-room is attached to this library for reading. In a library we get books on different subjects. There are books on literature, on history, hygiene, science and arts. A library is essential to the cultural progress of a country. It helps the country to fight illiteracy. It is an aid to research work and teaching. It satisfies a thirst for education. It is a boon to the poor and the middle class people. A civilized man cannot do without the library. Circulating libraries should be established in rural areas to fight illiteracy. As libraries spread education, every village and town should have one.";


		function cleanSentence(sentence) {
			try {	//if there aren't any periods or newlines to replace, this prevents an error 
				sentence = sentence.replace(".",""); //remove any period at the end of the sentence (if it's the last sentence, this period won't have been removed by split('.'))
				sentence = sentence.replace(".\n",".");
				sentence = sentence.replace( /[\r\n]+/gm, "" ); //replace all carriage returns, etc.
			} catch{}; 

			return sentence
		}

		function getOneSentence() {

			if(dataSource == "wikipedia" && needToLoadText != "yes"){  //a.k.a. if we still need to send a request to wikipedia API
				var separator = ". ";
				//hidden-text-div is where wikiSearch put the text
				listOfSentences = document.getElementById("hidden-text-div").textContent.split(separator);
			};

			if(randomMode) {
				rand = Math.floor(Math.random() * listOfSentences.length);
				sentenceString = listOfSentences[rand];
			} else {
				sentenceString = listOfSentences[count];

			};
			cleanSentence(sentenceString) ;
			return sentenceString;
		}

		function splitSentence() {  //what to do with the sentence once it done been got!

			try{
				sentenceWords = getOneSentence().split(' ');
			} catch{};

			if (learningMode!= 'jumble') {     //if cloze mode

				foundArticle = false;
				sentenceWords[sentenceWords.length-1] += '.';  //add period to last word

				if (count < listOfSentences.length-2) {  //as long as there are still 2 sentences left to get
					count++;  //get 2 sentences instead of 1 (better for articles, prepositions, etc)
					finishedSentences++;
					sentenceWords = sentenceWords.concat(getOneSentence().split(' '));
					sentenceWords[sentenceWords.length-1] += '.';
				};
			
				clozeSentence = [];  //reset it after completing a sentence
				clozeWords = [];

				for (i=0; i<sentenceWords.length; i++) {

					if (learningMode=='articles' && articleList.includes(sentenceWords[i]) || learningMode=='prepositions' && prepList.includes(sentenceWords[i]) || learningMode=='grammar' && grammarList.includes(sentenceWords[i])) {  //if the word is an article/preposition
						clozeWords.push(sentenceWords[i]); //these will be the word divs to click
						clozeSentence.push("_____"); //add a blank to the new clozeSentence array
						//this will be the sentence with blanks, added to the answerbox later
						foundArticle = true;
					} else{  //if not an article
						clozeSentence.push(sentenceWords[i]) //add the word to the new clozeSentence array
					}
				}

				jumbledSentence = shuffle(clozeWords);
			}
			else {  //if normal word jumble (jumble) learning mode
				console.log('Run as normal word jumble, no need to do anything');   
				sentenceWords = chunkArray(sentenceWords, wordGroupSize);  // Split up into word groups/chunks.  This is an array of arrays (chunks of words) in CORRECT ORDER.  Each array has a number of words equal to wordGroupSize.
				jumbledSentence = shuffle(sentenceWords);   //mix up the arrays within the array
			}
		};


		//must wait until Ajax is done getting Wikipedia text to run the following:
		//(it's the callback function of wikiSearch)
		function ready() {
			if (skip) {
				count++; 

							// do these things no matter which learning mode:
				$(this).css('visibility', 'hidden');

				wordsEntered ++;

				
				checkWin();
				skip=false;
				
			};
			splitSentence();
			makeDivs();
		}

		function getSettings() {
			//check the radio button settings:
			if(needToCheckRadios) {
				checkRadio('randomize');
				checkRadio('difficulty');
				checkRadio('datasource');
				checkRadio('language');
				checkRadio('learning');
			};
		}


		function loadTxtFile(filename) {
		//If loading from a txt file on computer
			var req = new XMLHttpRequest();
			req.open("GET", filename, true);
			req.send();
			var list;
			req.onreadystatechange = function() {
				if(this.readyState==4 && this.status==200) {
					console.log('Loaded ' + filename);
					grammarList = this.responseText.split(' ');
				};
			};		
		}


		function getText() {

			getSettings();

			switch(dataSource) {

				case "preset text":
					//Do nothing - listOfSentences was already set up via loadPresetTexts()
					ready();
					break;

				case "wikipedia":
					var searchTerm = document.getElementById('search-term').value;
					wikiSearch(searchTerm, language, "hidden-text-div", ready);
					break;

				case "paste":
					listOfSentences = document.getElementById('paste-input').value.split(". ");
					ready();
					break;

				default:   //if user chose to use the preset string of sentences
					listOfSentences = preMadeList.split(". ");
					ready();
			};	
		};

			/*JAPANESE VERSION (DOESN'T WORK):
				listOfSentences = document.getElementById("hidden-text-div").textContent.split("。");
				//split again by Japanese comma
				for (i=0; i<listOfSentences.length; i++) {

					var furtherSplit = listOfSentences[i].split("、");
					listOfSentences.splice(i);  //take out original sentence

					for (w=0; w<furtherSplit.length; w++) {
						listOfSentences.push(furtherSplit[w]);   //add back in newly split sentences
					};
 
				};
			};  */

		function makeDivs() {

			time = 500;

			//reset stuff:
			answerBox.style.backgroundColor = 'white';
			answerSentence.style.color = '#4286f4';
			undoHistory = [];
			undoCount = 0;
			clickedDivs = [];

			if (imageVisible) {
				answerBox.removeChild(imageContainer);
				imageVisible = false;
			};

			if (readingMode) {  //move the just-completed sentence to Previous Sentences before deleting answerSentence.innerHTML
				previousSentences.style.display = "block";
				previousSentences.innerHTML += " " + answerSentence.innerHTML;
			};
			
			answerSentence.innerHTML = '';
			
			$('.word-div').remove();   //clear all the word divs from the last round (also could do w/o JQuery)

			// If the sentence has no articles/prepositions/grammar words, create skip button (cloze modes only):
			if(learningMode != 'jumble' && !foundArticle) {
				var skipButton = document.createElement("div");
				skipButton.className = "word-div";
				skipButton.id = "skip-button";
				skipButton.innerHTML = "SKIP!";
				skip = true;
				skipButton.addEventListener("click", ready);
				document.getElementById("word-div-container").appendChild(skipButton);
			}


			function undo() {

				answerSentence.innerHTML = undoHistory[undoCount-1];  // undo by returning to the last answerSentence
				undoHistory.splice(undoHistory.length-1, 1);  //remove the last entry from undoHistory

				clickedDivs.splice(clickedDivs.length-1, 1);  //erase the undone word(s) from clickedDivs
				document.getElementById(wordsToUndo[wordsToUndo.length-1]).style.visibility = "visible";   //bring the last clicked word div back (its ID will be the last item in the wordsToUndo array)
				wordsToUndo.splice(wordsToUndo.length-1, 1);  //delete the undone word from wordsToUndo array
				wordsEntered --;
				undoCount --;
				console.log("undoCount = " + undoCount)	;
			}

			//Make the "undo" button:
			if(foundArticle || learningMode=='jumble') {
				var undoButton = document.createElement("div");
				undoButton.className = "small-box game-button";
				undoButton.id = "undo-button";
				undoButton.innerHTML = "Undo";
				undoButton.addEventListener("click", undo);
				answerBox.appendChild(undoButton);
			}


			wordsEntered = 0;

			// Display the cloze sentence:
			if (learningMode != 'jumble') {  // If cloze mode
				for(i=0; i<clozeSentence.length; i++) {  //clozeSentence is an array - must loop through to put each word in answer box as a string (or else it will show up with commas if set to innerHTML)
					answerSentence.innerHTML += clozeSentence[i] + ' ';
				};
				answerSentence.innerHTML = answerSentence.innerHTML.slice(0,answerSentence.innerHTML.length-1);//remove space at end
			}

			//create the word divs:
			for(i=0; i<jumbledSentence.length; i++) {

				var div = document.createElement('div');

				var wordChunk = jumbledSentence[i];  //if cloze mode, then jumbledSentence is actually word bank to fill in blanks.  Instead of making divs from the words IN the sentence, only use the words REMOVED from the sentence (Articles, prepositions, etc.)

				if(wordChunk.length > 7) {  //if many words in each div, make font smaller
					div.setAttribute('class','word-div small-text');   
				} else {
					div.setAttribute('class', 'word-div');
				};
				
				div.setAttribute('id', 'word-' + i);

				 
				for (j=0; j<wordChunk.length; j++) {     
					if (learningMode == 'jumble') { 
						div.innerHTML += wordChunk[j] + " ";
					} else { //add spaces between groups of words (not needed in cloze mode)
						div.innerHTML += wordChunk[j];
					}
				};
				
				div.addEventListener('click', clickedWord); 

				document.getElementById('word-div-container').appendChild(div);
			};
		};


		function clickedWord() {   //When you click a word/words

			answerSentence = document.getElementById('answersentence');  //get the current status of the answer

			wordsToUndo.push(this.id);
			undoHistory.push(answerSentence.innerHTML);  // save the sentence BEFORE blank is filled
			undoCount ++;  
			console.log("undoCount = " + undoCount)	;				
			clickedDivs.push(this.innerHTML);  //puts the clicked word(s) into an array
			

			if (learningMode != 'jumble') {  //if cloze mode:
				answerSentence.innerHTML = answerSentence.innerHTML.replace('_____', this.innerHTML);  //replace the FIRST blank with the clicked word
			}
			else {  //if normal word jumble (jumble) mode:
				answerSentence.innerHTML += clickedDivs[undoCount-1];  //add the word(s) to answerSentence
			}

			// do these things no matter which learning mode:
			$(this).css('visibility', 'hidden');
			

			wordsEntered ++;

			if(wordsEntered == i) {   //if all the words in the senetence have been entered
				checkWin();
			}
		};


		function checkWin() {

				answer = answerSentence.textContent;  //must use innerText, not innerHTML because &nbsp characters sometimes come up in wikipedia - innerText just renders them as normal spaces

				// IF CORRECT   (cloze modes do not add an extra space at the end)
				if(answer == sentenceString + ' ' || answer == sentenceWords.join(" ") && learningMode!='jumble' || skip==true) {  //if you're skipping this last sentence, automatically win, don't even check for correctness

				//below line not needed, it seems?  
				//	answerSentence.innerHTML = answer.substr(answer[0],answer.length-1) + '.'; //add period to the end

					//Inrease score:
					score += sentenceWords.length * time;
					finishedSentences ++;
					document.getElementById('score-box').innerHTML = "Score: " + score;	
					
					//Increase progress meter:
					var totalSentences = listOfSentences.length;
					progress = Math.floor(100*(finishedSentences / totalSentences));
					document.getElementById('progress-box-outer').innerHTML = "Progress: " + progress + "% <div id='progress-box-inner'></div>";
					document.getElementById('progress-box-inner').style.width = progress*2 + "px";

					if (progress == 100) {   // all sentences are finished - YOU WIN!
						win();
						return;  //stop reading this block of code (stuff below is for if you've not yet won the game)
					};

					if (rainbowMode) {
						changeScreenColor();				
					};

					// if not won yet, get the next sentence(s):
					if (randomMode) {
						listOfSentences.splice(listOfSentences.indexOf(sentenceString), 1);  //remove the sentence so it doesn't come up again
					} else {
						count ++   //move to the next sentence in listOfSentences (only if randomMode is off)
					};

					splitSentence();
					displayCharacter();
					setTimeout(makeDivs, 1000);  //Wait a sec before you get the next sentence
				}

				else {  //GAME OVER
					document.getElementById("undo-button").style.visibility = "hidden";
					answerBox.style.backgroundColor = 'red';
					answerSentence.style.backgroundColor = 'red';
					answerSentence.style.color = 'white';

					//display the correct answer:
					if (learningMode !='jumble') {
						answerSentence.innerHTML = sentenceWords.join(" ");
					} else {
					answerSentence.innerHTML = sentenceString;
					}
					$("#game-over").css("visibility", "visible");
					$(".reset-button").css("display", "inline-block");
		
					document.getElementById("main-menu-button").addEventListener("click", resetApp);
					document.getElementById("try-again-button").addEventListener("click", function() {
							tryAgain = true;
							resetApp();
						});
				};
			};
		



		//Generate random background colors:

		function randomColor() {
		        var alphabet = "a b c d e f 0 1 2 3 4 5 6 7 8 9".split(" ");
		        var hex1 = alphabet[Math.floor(Math.random()*alphabet.length)];
		        var hex2 = alphabet[Math.floor(Math.random()*alphabet.length)];
		        var hex3 = alphabet[Math.floor(Math.random()*alphabet.length)];
		        var hex4 = alphabet[Math.floor(Math.random()*alphabet.length)];
		        var hex5 = alphabet[Math.floor(Math.random()*alphabet.length)];
		        var hex6 = alphabet[Math.floor(Math.random()*alphabet.length)];
		        var colorHex = "#" + hex1 + hex2 + hex3 + hex4 + hex5 + hex6;
		        return colorHex;
		}

		function changeScreenColor() {
			var color = randomColor();
			document.body.style.backgroundColor = color;
			document.getElementById('word-div-container').style.backgroundColor = color;
		}

		function incrementTime() {

			var timeDiv = document.getElementById('timer');

			if (time == 0) {
				//stop decreasing time
				//$("#game-over").css("visibility", "visible");
				//setTimeout(resetApp, 2000);
			}

			else {
				time --;
				timeDiv.innerHTML = "Time: " + time; 
			}
		}

		function displayCharacter() {
			var imageFile = "images/playing" + Math.floor(Math.random()*7+1) +".gif";
			imageDiv = document.createElement("div");
			imageContainer = document.createElement("div");
			var yeah = document.createElement("div");

			yeah.innerHTML = "GREAT!";
			//yeah.style.color = "#0aff4b";
			//yeah.style.backgroundColor = "#fcf403";
			yeah.id = "yeah";

			imageContainer.className = "image-container float-right";
			
			imageDiv.className = "character-div";
			imageDiv.style.height = "200px";
			imageDiv.style.background = "url('" + imageFile + "')";
			imageDiv.style.backgroundSize = "contain";
			imageDiv.style.backgroundRepeat = "no-repeat";

			imageContainer.appendChild(imageDiv);
			imageContainer.appendChild(yeah);

			answerBox.appendChild(imageContainer);

			imageVisible = true;
		}



		function resetApp() {
			
			//reset variables:
			saved = false;
			score = 0;
		 	count = 0;
		 	skip = false;
		 	wordsEntered = 0;
		 	undoCount = 0;
		 	finishedSentences = 0;
		 	needToCheckRadios = true;
	 	    sentenceString = '';
		    wordsToUndo =[];
		    clickedDivs = [];
			progress = 0;
			previousSentences.style.display = "none";
			answerBox.style.backgroundColor = 'white';
			answerSentence.style.backgroundColor = 'white';
			answerSentence.style.color = '#4286f4';
			document.getElementById('progress-box-outer').innerHTML = "Progress: " + progress + "% <div id='progress-box-inner'></div>";
			document.getElementById('progress-box-inner').style.width = progress;
		    document.getElementById('answersentence').innerHTML = '';

			if (youWon) {
				document.body.removeChild(winScreen);
				youWon = false;
			} else {
				$("#game-over").css("visibility", "hidden");
				$(".reset-button").css("display", "none");
			};

			if (tryAgain) {
				tryAgain = false; //reset it
				ready();
				return; //don't do any of the below stuff
			};

			if (dataSource == 'load'){
				document.body.removeChild(loadScreen);
			};

			if (saved){
				document.body.removeChild(saveScreen);
			};
			
			document.getElementById('paste-input').value = "";
			document.getElementById('search-term').value = "";  
			document.getElementById('start-screen').style.left = "0px";
		}


		function createScreen(innerHtml) {
			var screen = document.createElement("div");
			screen.className="screen";
			screen.innerHTML = innerHtml;
			return screen;
		}


		function win() {
			youWon = true;

			var victoryImageFile = "images/victory" + Math.floor(Math.random()*6+1) +".gif";
			var victoryImageDiv = document.createElement("div");
			
			victoryImageDiv.className = "victory-image-div";
			//victoryImageDiv.style.height = "400px";
			victoryImageDiv.style.background = "url('" + victoryImageFile + "')";
			victoryImageDiv.style.backgroundSize = "contain";
			victoryImageDiv.style.backgroundRepeat = "no-repeat";

			var winScreenHtml = "<img src='images/congrats.png' height=200px/><br><br><br><h2>You completed</h2><br><h1>" + listOfSentences.length + "</h1><br><h3>sentences.</h3><br>"
			winScreen = createScreen(winScreenHtml);
			winScreen.addEventListener("click", resetApp);
			document.body.appendChild(winScreen);

			var victoryImageContainer = document.createElement("div");
			victoryImageContainer.className = "victory-image-container";
			

			victoryImageContainer.appendChild(victoryImageDiv);

			winScreen.appendChild(victoryImageContainer);
		}
     

		addEventListener('keydown', function(event) {   //Press Enter to start
			if (event.keyCode == 13) {
				runApp();
			};
		});




		//JQuery version of AJAX request::

/*
		const getText = function() {

			$.get('sentences.txt', function(data){})

		    .then(data => {	  // use this format to run function only after json get is done (since it's async)
		    				  // "data" is the contents of the text file
				listOfSentences = data.split('\n');
				console.log('Made sentence array');
				splitSentence();
				makeDivs();

		 	});

			makeDivs();

		};
		*/

		//To use a list of senences in Excel:
		//first convert list of sentences to JSON with this website: http://www.convertcsv.com/csv-to-json.htm
		//make sure to choose "CSV to JSON Array" at the bottom

	</script>
</body>